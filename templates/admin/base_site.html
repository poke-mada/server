{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
    {{ block.super }}
    <script>
        (function () {
            try {
                const tz = Intl.DateTimeFormat().resolvedOptions().timeZone; // ej: "America/Chihuahua"
                if (!tz) return;

                // Evita posteos repetidos innecesarios por sesiÃ³n
                const KEY = "admin_tz_sent";
                if (sessionStorage.getItem(KEY) === tz) return;

                // Usa CSRF del cookie si tienes CSRF activo en admin (recomendado)
                function getCookie(name) {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return parts.pop().split(';').shift();
                }

                const csrftoken = getCookie('csrftoken');

                fetch("{% url 'set_timezone' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        ...(csrftoken ? {"X-CSRFToken": csrftoken} : {})
                    },
                    body: new URLSearchParams({tz})
                }).then(r => {
                    if (r.ok) sessionStorage.setItem(KEY, tz);
                }).catch(() => {
                });
            } catch (e) {
            }
        })();
    </script>
{% endblock %}
